name: Reusable App Build and Dockerize

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
      app_version:
        required: true
        type: string
      engine_type: # java or node
        required: true
        type: string
      engine_version:
        required: true
        type: string
    secrets:
      GHCR_TOKEN:
        required: true
        type: string

jobs:
  build-and-dockerize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4
        with:
          path: 'app-repo'

      - name: Checkout infrastructure repo
        uses: actions/checkout@v4
        with:
          repository: 'PTarasyuk/GreenCityInfra'
          path: 'infra-repo'

      - name: Render Dockerfile
        env:
          ENGINE_VERSION: ${{ inputs.engine_version }}
        run: |
          wget https://github.com/kelseyhightower/confd/releases/download/v0.16.0/confd-0.16.0-linux-amd64
          chmod +x confd-0.16.0-linux-amd64
          sudo mv confd-0.16.0-linux-amd64 /usr/local/bin/confd
          confd -onetime \
                -backend env \
                -confdir infra-repo/ci-cd/confd \
                -config-file infra-repo/ci-cd/confd/conf.d/Dockerfile-${{ inputs.engine_type }}.toml
          mv /tmp/Dockerfile /app-repo/Dockerfile
      
      - name: Build and push Docker image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: ./infra-repo
          file: ./infra-repo/Dockerfile
          build-args: |
            SKIP_TESTS: true
          registry: ghcr.io
          image: PTarasyuk/GreenCityInfra/${{ inputs.app_name }}:${{ inputs.app_version }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}
